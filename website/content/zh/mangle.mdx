import { Callout } from 'nextra/components'

# 2.Mangle

## 功能简介

```html
<!-- 修改前 -->
<div class="z-10 w-full max-w-5xl items-center justify-between font-mono text-sm lg:flex"></div>
<!-- 修改后 -->
<div class="tw-g tw-h tw-i tw-d tw-e tw-j tw-k tw-l"></div>
```

`unplugin-tailwindcss-mangle` 会读取 `tailwindcss-patch` 生成的类名清单，在模板、JSX、MDX 与内联字符串中重写匹配的类名，从而让最终产物更紧凑、也更难被猜测。

## 快速上手

1. 安装依赖。

   ```sh npm2yarn
   npm i -D tailwindcss-patch unplugin-tailwindcss-mangle
   ```

2. 为 Tailwind 打补丁并提取类名。

   ```sh
   npx tw-patch install
   npx tw-patch extract
   ```

3. 在 `package.json` 中添加 `prepare`，确保安装后自动打补丁。

   ```json
   {
     "scripts": {
       "prepare": "tw-patch install"
     }
   }
   ```

4. 在构建工具中注册插件。通常推荐复用 `config.transformer`，CLI 与插件即可共享一份配置。

<Callout type="info">
配置文件会在 CLI 与插件之间自动共享，只需在 <a href="../config">Config</a> 中维护一次路径或过滤器即可。
</Callout>

## 支持的构建工具

### Vite

```ts
// vite.config.ts
import vue from '@vitejs/plugin-vue'
import tailwindcssMangle from 'unplugin-tailwindcss-mangle/vite'
import appConfig from './tailwindcss-patch.config'
import { defineConfig } from 'vite'

export default defineConfig({
  plugins: [
    vue(),
    tailwindcssMangle({
      ...appConfig.transformer,
    }),
  ],
})
```

### Webpack

```js
// webpack.config.js
const { webpackPlugin: tailwindcssMangle } = require('unplugin-tailwindcss-mangle')
const appConfig = require('./tailwindcss-patch.config')

module.exports = {
  // ...
  plugins: [
    tailwindcssMangle({
      ...appConfig.transformer,
    }),
  ],
}
```

### Rollup

```ts
// rollup.config.ts
import tailwindcssMangle from 'unplugin-tailwindcss-mangle/rollup'
import appConfig from './tailwindcss-patch.config'

export default {
  plugins: [
    tailwindcssMangle({
      ...appConfig.transformer,
    }),
  ],
}
```

### Nuxt 3

```ts
// nuxt.config.ts
import tailwindcssMangle from 'unplugin-tailwindcss-mangle/nuxt'
import appConfig from './tailwindcss-patch.config'

export default defineNuxtConfig({
  experimental: {
    inlineSSRStyles: false,
  },
  modules: [
    [
      tailwindcssMangle,
      {
        ...appConfig.transformer,
      },
    ],
  ],
})
```

### Esbuild

如需复用共享配置，将 `tailwindcssMangle({ ...appConfig.transformer })` 替换到插件列表即可。

```ts
// build.mjs
import { build } from 'esbuild'
import tailwindcssMangle from 'unplugin-tailwindcss-mangle/esbuild'

await build({
  entryPoints: ['src/main.ts'],
  bundle: true,
  outfile: 'dist/index.js',
  plugins: [tailwindcssMangle()],
})
```

## 插件选项

可以直接在插件中配置，也可以通过共享配置文件统一管理。

- `registry.file` —— 指向 `tw-patch extract` 生成的类名清单。
- `sources.include` / `sources.exclude` —— 调整插件扫描的文件范围，默认覆盖 HTML、主流框架、CSS 与 MDX。
- `filter` —— 在生成前自定义类名过滤逻辑。
- `generator` —— 自定义压缩后的类名，例如 `classPrefix`、`reserveClassName`、`customGenerate`。
- `registry.mapping` —— 设为 `true` 重用默认写盘；提供 `{ enabled, file, loose }` 或回调自定义输出。
- `preserve.functions` —— 声明包装函数（如 `twIgnore`），用于标记需要保留的模板字面量。
- `disabled` —— 设为 `true` 时跳过混淆（默认在开发环境关闭）。

## 编译器感知的 AST 转换流程

当前实现会将命中的文件路由到最合适的处理器：

- `jsHandler`：用于 JS/TS/JSX/TSX 与脚本子请求。
- `vueHandler`：用于完整 `.vue` SFC 文件。
- `svelteHandler`：用于完整 `.svelte` 文件。
- `cssHandler`：用于 CSS 请求与样式子请求。
- `htmlHandler`：用于 HTML 文件及“模板形态”的标记内容。

分流依据是组合策略，而不是单一后缀：

- 文件扩展名（如 `.vue`、`.svelte`、`.html`、JS 系列后缀）；
- 查询参数（`type=script|style|template`、`lang=...`）；
- 对未知文件内容进行源码形态判断（例如是否是 markup-like 模板）。

这比仅按后缀判断更精确，特别适合多阶段构建流水线。

### Webpack 防护策略

- 对 HTML 文件请求在 transform loader 层做排除，避免 child compilation 被当作 JS 解析。
- CSS 链路仍围绕 `postcss-loader` 进行插入与产物后处理，减少对非目标资源的干扰。

## 框架快速映射

| 框架 | 使用方式 | 备注 |
| --- | --- | --- |
| React (Vite) | `unplugin-tailwindcss-mangle/vite` + `@vitejs/plugin-react` | 展开 `config.transformer`，Fast Refresh 仍然可用。 |
| Vue 3 (Vite) | `unplugin-tailwindcss-mangle/vite` + `@vitejs/plugin-vue` | 支持 `<script setup>` 与 scoped 样式。 |
| Svelte (Vite) | `unplugin-tailwindcss-mangle/vite` + `@sveltejs/vite-plugin-svelte` | 默认规则覆盖 `.svelte` 与共存 CSS 文件。 |
| Next.js (Webpack) | `unplugin-tailwindcss-mangle/webpack` 在 `next.config.{js,mjs}` 中调用 | 仅在生产构建执行，请在 `registry` 中维护 Tailwind 提取配置。 |
| Nuxt 3 | `unplugin-tailwindcss-mangle/nuxt` 加入 `modules` | 关闭 `inlineSSRStyles`，让 Vite 输出 CSS 供扫描。 |

## 忽略与保留

使用 `preserveFunction` 可以保留某些字符串，默认内置的 `twIgnore` 可用于模板字面量：

```js
const twIgnore = String.raw
const className = `${twIgnore`gap-y-4`} bg-zinc-800/30`
```

混淆后的结果：

```js
const twIgnore = String.raw
const className = `${twIgnore`gap-y-4`} tw-a`
```

启用 `classMapOutput` 可以在 `.tw-patch/tw-map-list.json` 中查看前后类名以及引用位置，便于排查问题。

## 注意事项

- 插件仅会转换包含 `-` 或 `:` 的工具类，例如 `w-32`、`before:h-[300px]`、`after:dark:via-[#0141ff]/40`。像 `flex` 这类基础类名会被保留，以避免误伤。
- 默认只在生产构建阶段启用混淆；如果需要在开发环境尝试，可设置 `disabled: false`。
- 插件会遍历 HTML `class` 属性与常见的字符串字面量，请避免在运行时对任意字符串进行难以预测的动态修改。
