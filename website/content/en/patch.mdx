import { Callout } from 'nextra/components'

# 1. Patch

`tailwindcss-patch` is the first step of the mangling workflow. Version 8.0 refactors the package so you can capture runtime contexts, enumerate every Tailwind CSS class, and keep the results in sync with modern projects.

## Tailwindcss-Patch 8.0 at a glance

- Re-architected modules (`api/`, `patching/`, `runtime/`, `extraction/`, `cache/`) with typed entry points for direct imports.
- Unified `registry` configuration that normalises legacy `patch`/`cache` configs and unlocks cache, output, and feature flags in one place.
- First-class Tailwind CSS v4 support by scanning CSS entry files and project sources alongside the existing v2/v3 runtime patch.
- Refreshed CLI with clearer logging plus new `extract` flags (`--output`, `--format`, `--css`, `--no-write`) for automation.

<Callout type="info">
Need upgrade guidance? See the <a href="./migration">migration guide</a> for a step-by-step checklist from v7.x.
</Callout>

## Installation

Make sure your environment runs Node.js 18 or newer.

### Add the package

```sh npm2yarn
npm i -D tailwindcss-patch
```

### Apply Tailwind runtime patches

```sh npm2yarn
npx tw-patch install
```

### Keep the patch after installs

`package.json`

```json
{
  "scripts": {
    "prepare": "tw-patch install"
  }
}
```

## CLI workflow

The CLI is available via `tw-patch`. Run commands from the project root that contains `tailwind.config.*`.

```sh
npx tw-patch install
npx tw-patch extract
```

By default `extract` writes `.tw-patch/tw-class-list.json`. Customise the destination or output shape with the following flags:

| Flag | Description |
| --- | --- |
| `--cwd <dir>` | Resolve configuration from another working directory. |
| `--output <file>` | Override the target file written by `extract`. |
| `--format <json|lines>` | Emit JSON (default) or newline-delimited text. |
| `--css <file>` | Provide CSS entry files used by Tailwind v4 builds. Repeat for multiple files. |
| `--no-write` | Skip writing to disk and return the class list to the caller. |

The CLI reads `tailwindcss-patch.config.ts` (or legacy `tailwindcss-mangle.config.ts`) through `@tailwindcss-mangle/config`, so existing configs remain valid.

## Configuration

Initialize a config file if you do not already have one:

```sh npm2yarn
npx tw-patch init
```

`tailwindcss-patch.config.ts`

```ts
import { defineConfig } from 'tailwindcss-patch'

export default defineConfig({
  registry: {
    output: {
      file: '.tw-patch/tw-class-list.json',
      format: 'json',
      pretty: 2,
      stripUniversalSelector: true,
    },
    tailwind: {
      version: 4,
      next: {
        cssEntries: ['dist/tailwind.css'],
        sources: [
          { base: 'src', pattern: '**/*.{html,tsx}', negated: false },
        ],
      },
    },
    features: {
      exportContext: true,
      extendLengthUnits: {
        units: ['rpx'],
      },
    },
  },
})
```

`defineConfig` still accepts legacy `patch` / `mangle` fields, converting them to the new `registry` / `transformer` shape so you can migrate at your own pace. Newly added fields are normalised automatically at runtime.

## Programmatic API

The modern constructor accepts the unified options object. Legacy objects with `patch`/`cache` keys are still converted internally.

```ts
import { TailwindcssPatcher } from 'tailwindcss-patch'

const patcher = new TailwindcssPatcher({
  overwrite: true,
  cache: {
    enabled: true,
    dir: '.tw-patch/cache',
    strategy: 'merge',
    driver: 'file',
  },
  output: {
    file: '.tw-patch/tw-class-list.json',
    format: 'json',
    pretty: 2,
  },
  features: {
    exposeContext: { refProperty: 'runtimeContexts' },
    extendLengthUnits: { units: ['rpx'] },
  },
  tailwind: {
    version: 4,
    v4: {
      base: './src',
      cssEntries: ['dist/tailwind.css'],
    },
  },
})

await patcher.patch()
const { classList, filename } = await patcher.extract()
const contexts = patcher.getContexts()
const classSet = await patcher.getClassSet()
```

### Helper utilities

Specific helpers are available for custom tooling:

- `CacheStore` – persistent cache manager (file, memory, or noop drivers) that merges or overwrites class sets.
- `normalizeOptions` – convert raw user input to the runtime-ready shape.
- `extractValidCandidates` – Tailwind v4 candidate extractor backed by the Oxide scanner.
- `runTailwindBuild` – run Tailwind v2/v3 builds to materialise runtime contexts.

## Typical upgrade checklist

1. Install `tailwindcss-patch@^8.0.0` and run `tw-patch install`.
2. Review custom imports from `tailwindcss-patch/core/*` and switch to the new public modules.
3. Refresh CLI scripts with the new flags where applicable.
4. Configure Tailwind v4 projects by declaring `cssEntries` and `sources`.
5. Regenerate `.tw-patch/tw-class-list.json` with `tw-patch extract` and verify the output before proceeding to the mangling step.
